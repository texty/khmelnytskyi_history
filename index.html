<!DOCTYPE html>
        <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
            <title>Хмельницький</title>


              <link rel="stylesheet" href="libs/leaflet.css" />
              <link rel="stylesheet" href="css/styles.css" />


              <script src="libs/leaflet.js"></script>
              <script src="libs/leaflet.ajax.min.js"></script>
              <script src="libs/leaflet-providers.js"></script>
              <script src="libs/jquery-3.3.1.js"></script>
              <script src="libs/scrollama.min.js"></script>



              <style>


            </style>

        </head>
        <body>




        <section id='scroll' class="desktop-only">
            <div class='scroll__graphic sticky'>
                <div id="map-wrapper">
                    <div id="map"></div>
                </div>
            </div>



            <div class='scroll__text'>
                <div class='step' data-step='0' data-scrollama-index="0">
                    <div>
                    </div>
                </div>

                <div class='step' data-step='1' data-scrollama-index="1">
                    <div>
                        <p id="step_1" data-stuff='["step_800_850_1", "none"]' class="change_period active">1800-1850(1)</p>
                    </div>
                </div>

                <div class='step' data-step='2' data-scrollama-index="2">
                    <div>
                        <p id="step_2" data-stuff='["step_800_850_2", "step_800_850_1"]' class="change_period">1800-1850(2)</p>
                    </div>
                </div>

                <div class='step' data-step='3' data-scrollama-index="3">
                    <div>
                        <p id="step_3" data-stuff='["step_850_900_1", "step_800_850_2"]' class="change_period">1850-1900(1)</p>
                    </div>
                </div>

                <div class='step' data-step='4' data-scrollama-index="4">
                    <div>
                        <p id="step_4" data-stuff='["step_900_921_1", "step_850_900_1"]' class="change_period">1900-1921(1)</p>
                    </div>
                </div>

                <div class='step' data-step='5' data-scrollama-index="5">
                    <div>
                        <p id="step_5" data-stuff='["step_921_940_1", "step_900_921_1"]' class="change_period">1921-1945(1)</p>
                    </div>
                </div>

                <div class='step' data-step='6' data-scrollama-index="6">
                    <div>
                        <p id="step_6" data-stuff='["step_940_960_1", "step_921_940_1"]' class="change_period">1945-1960(1)</p>
                    </div>
                </div>

                <div class='step' data-step='7' data-scrollama-index="7">
                    <div>
                        <p id="step_7" data-stuff='["step_960_970_1", "step_940_960_1"]' class="change_period">1960-1970(1)</p>
                    </div>
                </div>

                <div class='step' data-step='8' data-scrollama-index="8">
                    <div>
                        <p id="step_8" data-stuff='["step_970_980_1", "step_960_970_1"]' class="change_period">1970-1980(1)</p>

                    </div>
                </div>

                <div class='step' data-step='9' data-scrollama-index="9">
                    <div>
                        <p id="step_9" data-stuff='["step_980_990_1", "step_970_980_1"]' class="change_period">1980-1990(1)</p>
                    </div>
                </div>

                <div class='step' data-step='10' data-scrollama-index="10">
                    <div>
                        <p id="step_10" data-stuff='["step_991_1", "step_980_990_1"]' class="change_period">1990+(1)</p>
                    </div>
                </div>




            </div>
        </section>



        <script>
        /* **** Leaflet **** */




        var attrib = 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'


        // Map
        var map = L.map('map').setView([49.4183008183, 26.9870752526], 14);
//        {
//            center: [49.4183008183, 26.9870752526],
//            zoom: 14,
//            minZoom: 5,
//            maxZoom: 17,
//            //autoZIndex: false,
//            scrollWheelZoom: false
//        });


        //set layers order (оце, мабуть, вже не треба, бо відмовились від старих карт
        map.createPane('oldmaps');
        map.createPane('builgings');


        //add canvas renderer to builgings pane
        var buildingsRenderer = L.canvas({ padding: 0.5, pane: 'builgings' });



        L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 20,
            ext: 'png',
            scrollWheelZoom: false
        }).addTo(map);


//L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
//            attribution: attrib
//}).addTo(map);


        /*створюємо шари на всі scrolling steps */
        var step_800_850_1 = new L.LayerGroup(), step_800_850_2 = new L.LayerGroup(), step_800_850_3 = new L.LayerGroup();
        var step_850_900_1 = new L.LayerGroup(), step_850_900_2 = new L.LayerGroup(), step_850_900_3 = new L.LayerGroup();
        var step_900_921_1 = new L.LayerGroup(), step_900_921_2 = new L.LayerGroup(), step_900_921_3 = new L.LayerGroup();
        var step_921_940_1 = new L.LayerGroup(), step_921_940_2 = new L.LayerGroup(), step_921_940_3 = new L.LayerGroup();
        var step_940_960_1 = new L.LayerGroup(), step_940_960_2 = new L.LayerGroup(), step_940_960_3 = new L.LayerGroup();
        var step_960_970_1 = new L.LayerGroup(), step_960_970_2 = new L.LayerGroup(), step_960_970_3 = new L.LayerGroup();
        var step_970_980_1 = new L.LayerGroup(), step_970_980_2 = new L.LayerGroup(), step_970_980_3 = new L.LayerGroup();
        var step_980_990_1 = new L.LayerGroup(), step_980_990_2 = new L.LayerGroup(), step_980_990_3 = new L.LayerGroup();
        var step_991_1 = new L.LayerGroup(), step_991_2 = new L.LayerGroup(), step_991_3 = new L.LayerGroup();


        //новий стиль, задаємо для шарів, які зараз неактивні
        var pastStyle = {
            opacity: 0.5,
            fillOpacity: 0.3
        };

        var newStyle = {
            opacity: 1,
            fillOpacity: 0.6
        };

        var mouseoverStyle = { color: "grey", weight: 3 };
        var mouseleaveStyle = { color: "transparent" };

        //це якщо треба додати можливість вмикати/вимикати шари
        //var layerControl = L.control.layers().addTo(map);
        //layerControl.addOverlay(buldings_900_921, "buldings_900_921");


        // плани різних років з тайлів (поки не треба)
//        var p_800 = L.tileLayer('./tiles/plan_1800/{z}/{x}/{y}.png', {tms: true, opacity: 0.9, attribution: "",  pane: 'oldmaps'});
//        var p_944 = L.tileLayer('./tiles/plan_1944/{z}/{x}/{y}.png', {tms: true, opacity: 0.9, attribution: "",  pane: 'oldmaps'});
//        var p_888 = L.tileLayer('./tiles/plan_1888/{z}/{x}/{y}.png', {tms: true, opacity: 0.9, attribution: "",  pane: 'oldmaps'});


        var buildingsColor = "#9d2f32", //"#f14633", //"#9d2f32",
                polygonsFillColor = "#D1E7E0", //"#899e91", //"#bbcda9", // "#fce0bc", //"#899e91", //"#a79d70",
                linesColor = "#0062A6", //'#4783fe',
                pointsColor = "#ff9d04"; //'#D7A319';


        var polygonsFillStyle = {
            weight: 1,
            fillOpacity: 0.7,
            opacity: 1,
            fillColor: polygonsFillColor,
            color: polygonsFillColor
        };

        var polygonsColorStyle = {
            weight: 2,
            opacity: 1,
            fillColor:"transparent",
            color: '#374969',
            dashArray: '5, 5',
            dashOffset: '0'
        };

        var buildingsStyle = {
            weight: 1,
            fillColor: buildingsColor,
            fillOpacity: 0.6,
            color: buildingsColor,
            opacity: 1
        };


        var geojsonMarkerOptions = {
            radius: 4,
            fillColor: pointsColor,
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        function filterBuildingsByPeriod(data, property, period, popup, style){
            return L.geoJson(data, {
                filter: function(feat) { return feat.properties[property] == period},
                renderer: buildingsRenderer,
                style: function(){ return  style },
                onEachFeature: onEachFeatureClosure(buildingsColor, 1)
            }).bindPopup(popup);
        }

        function filterPoligonsByPeriod(data, property, period, popup, style){
            return L.geoJson(data, {
                filter: function(feat) { return feat.properties[property] == period},
                renderer: buildingsRenderer,
                style: function(){ return  style }
               // onEachFeature: onEachFeatureClosure(buildingsColor, 1)
            }).bindPopup(popup);
        }


        function filterLinesByPeriod(data, streetlist, popup){
            return L.geoJson(data, {
                filter: function(feat) { return  streetlist.includes(feat.properties["name"]) },
                renderer: buildingsRenderer,
                style: function(){ return  { "color": linesColor, 'opacity': 1 } },
                onEachFeature: onEachFeatureClosure("blue", 3)
            }).bindPopup(popup);
        }


        function filterPointsByPeriod(data, property, period, popup){
            return L.geoJson(data, {
                filter: function(feat) { return feat.properties[property] == period},
                renderer: buildingsRenderer,
                onEachFeature: onEachFeatureClosure("green", 1),
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            }).bindPopup(popup);
        }

        fetch("data/polygonsData_4326_fill.geojson")
                .then(function (response) { return response.json() })
                .then(function (data) {
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "-1800", "polygon", polygonsFillStyle).addTo(step_800_850_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1850-1900", "polygon", polygonsFillStyle).addTo(step_850_900_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1900-1921", "polygon", polygonsFillStyle).addTo(step_900_921_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1921-1940", "polygon", polygonsFillStyle).addTo(step_921_940_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1940-1960", "polygon", polygonsFillStyle).addTo(step_940_960_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1960-1970", "polygon", polygonsFillStyle).addTo(step_960_970_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1970-1980", "polygon", polygonsFillStyle).addTo(step_970_980_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1980-1990", "polygon", polygonsFillStyle).addTo(step_980_990_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1980-1990", "polygon", polygonsFillStyle).addTo(step_980_990_1);
                });


        fetch("data/polygonsData_4326_color.geojson")
                .then(function (response) { return response.json() })
                .then(function (data) {
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "-1800", "polygon", polygonsColorStyle).addTo(step_800_850_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1850-1900", "polygon", polygonsColorStyle).addTo(step_850_900_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1900-1921", "polygon", polygonsColorStyle).addTo(step_900_921_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1921-1940", "polygon", polygonsColorStyle).addTo(step_921_940_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1940-1960", "polygon", polygonsColorStyle).addTo(step_940_960_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1960-1970", "polygon", polygonsColorStyle).addTo(step_960_970_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1970-1980", "polygon", polygonsColorStyle).addTo(step_970_980_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1980-1990", "polygon", polygonsColorStyle).addTo(step_980_990_1);
                    filterPoligonsByPeriod(data, "Data polygonsData_period", "1980-1990", "polygon", polygonsColorStyle).addTo(step_980_990_1);
                });


        fetch("data/osmData_4326.geojson")
            .then(function (response) { return response.json() })
            .then(function (data) {
                filterBuildingsByPeriod(data, "Data osmData_period", "1800-1850", "bulding", buildingsStyle).addTo(step_800_850_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1850-1900", "bulding", buildingsStyle).addTo(step_850_900_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1900-1921", "bulding", buildingsStyle).addTo(step_900_921_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1921-1940", "bulding", buildingsStyle).addTo(step_921_940_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1940-1960", "bulding", buildingsStyle).addTo(step_940_960_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1960-1970", "bulding", buildingsStyle).addTo(step_960_970_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1970-1980", "bulding", buildingsStyle).addTo(step_970_980_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1980-1990", "bulding", buildingsStyle).addTo(step_980_990_1);
                filterBuildingsByPeriod(data, "Data osmData_period", "1991-", "bulding", buildingsStyle).addTo(step_991_1);
            });


        fetch("data/linesData_4326.geojson")
                .then(function (response) { return response.json() })
                .then(function (data) {
                    filterLinesByPeriod(data, ["Шлях на Кам'янець", "Шлях на Летичів"], "line").addTo(step_800_850_1);
                    filterLinesByPeriod(data,["Вул. Кам'янецька", "вул. Ремісницька", "вул. Соборна", "вул. Набережна", "вул. Аптекарська", "вул. Старобульварна", "вул. Коммерційна", "вул. Купецька", "Вул. Дворянська"], "line").addTo(step_800_850_2);
                });


        fetch("data/pointsData_4326.geojson")
                .then(function (response) { return response.json() })
                .then(function (data) {
                    filterPointsByPeriod(data, "Data pointsData_period", "-1800", "point").addTo(step_800_850_1);
                    filterPointsByPeriod(data, "Data pointsData_period", "1800-1850", "point").addTo(step_800_850_1);
                    filterPointsByPeriod(data, "Data pointsData_period", "1850-1900", "point").addTo(step_850_900_1);
                    filterPointsByPeriod(data, "Data pointsData_period", "1900-1921", "point").addTo(step_900_921_1);






                });



//        function getColor(d) { return d > 1980 ? 'green' :  d > 1950  ? 'red' :  'blue'; }
//
//        function buildingsStyle(feature) {
//           return {
//               fillColor: getColor(feature.properties["Data osmData_StartYear"]),
//               weight: 1,
//               color: getColor(feature.properties["Data osmData_StartYear"]),
//               fillOpacity: 0.5  };
//        }


        //щоб передати змнну у кожен клік
        function onEachFeatureClosure(defaultColor, weightValue) {
            return function onEachFeature(feature, layer) {
                layer.on('mouseover', function (e) {  e.target.setStyle(mouseoverStyle); });
                layer.on('mouseout', function (e) {  e.target.setStyle({ color: defaultColor, weight: weightValue }); });
            }
        }



        //step_800_850_1.addTo(map);


       // міняємо періоди по кліку
        $(".change_period").on("click", function(){
            $(".change_period").removeClass("active");
            $(this).addClass("active");
            let myarray = $(this).data('stuff');
            eval(myarray[0]).addTo(map);

            if(myarray[1] != "none"){
                eval(myarray[1]).eachLayer(function(layer) {
                    layer.setStyle(pastStyle);
                });
            }
        });


        var container = $('#scroll');
        var graphic = $('#scroll > .scroll__graphic'); //container.select('.scroll__graphic');
        var text = $('#scroll > .scroll__text'); //container.select('.scroll__text');
        var step = $('#scroll > .scroll__text > .step'); // text.selectAll('.step');
        var scroller = scrollama();


//        function handleResize() {
//            var stepHeight = Math.floor(window.innerHeight * 0.5);
//            step.css('height', stepHeight + 'px');
//            var bodyWidth = d3.select('body').node().offsetWidth;
//            var textWidth = text.node().offsetWidth;
//            var graphicWidth = bodyWidth - textWidth;
//            var chartMargin = 32;
//            var chartWidth = graphic.node().offsetWidth - chartMargin;
//            scroller.resize();
//        }

        // scrollama event handlers
        function handleStepEnter(r) {
            if (r.index === 1 && r.direction === "down") {
                step_800_850_1.addTo(map);
            }
            if (r.index === 1 && r.direction === "up") {
                map.removeLayer(step_800_850_2);
                step_800_850_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
            }
            if (r.index === 2 && r.direction === "down") {
                step_800_850_2.addTo(map);
                step_800_850_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 2 && r.direction === "up") {
                map.removeLayer(step_850_900_1);
                step_800_850_2.eachLayer(function(layer) { layer.setStyle(newStyle); });
            }
            if (r.index === 3 && r.direction === "down") {
                step_850_900_1.addTo(map);
                step_800_850_2.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 3 && r.direction === "up") {
                map.removeLayer( step_900_921_1);
                step_850_900_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
            }
            if (r.index === 4 && r.direction === "down") {
                step_900_921_1.addTo(map);
                step_850_900_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 4 && r.direction === "up") {
                map.removeLayer( step_921_940_1);
                step_900_921_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
            }
            if (r.index === 5 && r.direction === "down") {
                step_921_940_1.addTo(map);
                step_900_921_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 5 && r.direction === "up") {
                step_921_940_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
                map.removeLayer( step_940_960_1);
            }
            if (r.index === 6 && r.direction === "down") {
                step_940_960_1.addTo(map);
                step_921_940_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 6 && r.direction === "up") {
                step_940_960_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
                map.removeLayer( step_960_970_1);
            }
            if (r.index === 7 && r.direction === "down") {
                step_960_970_1.addTo(map);
                step_940_960_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 7 && r.direction === "up") {
                step_960_970_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
                map.removeLayer( step_970_980_1);
            }
            if (r.index === 8 && r.direction === "down") {
                step_970_980_1.addTo(map);
                step_960_970_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 8 && r.direction === "up") {
                step_960_970_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
                map.removeLayer( step_980_990_1);
            }
            if (r.index === 9 && r.direction === "down") {
                step_980_990_1.addTo(map);
                step_970_980_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
            if (r.index === 9 && r.direction === "up") {
                step_980_990_1.eachLayer(function(layer) { layer.setStyle(newStyle); });
                map.removeLayer( step_991_1);
            }
            if (r.index === 10 && r.direction === "down") {
                step_991_1.addTo(map);
                step_980_990_1.eachLayer(function(layer) { layer.setStyle(pastStyle); });
            }
        }


        function handleContainerEnter(response) {
            // response = { direction }
        }

        function handleContainerExit(response) {
            // response = { direction }
        }



        function init() {
            //handleResize();
            scroller.setup({
                container: '#scroll',
                graphic: '.scroll__graphic',
                text: '.scroll__text',
                step: '.scroll__text .step',
                offset: 0.9,
                debug: false
            })
                    .onStepEnter(handleStepEnter)
                    .onContainerEnter(handleContainerEnter)
                    .onContainerExit(handleContainerExit);
            //window.addEventListener('resize', handleResize);
        }
        init();









        </script>
  </body>
</html>

        
